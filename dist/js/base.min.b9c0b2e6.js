var locationDatas=[{name:"天安门",type:"location",location:{lat:39.909191,lng:116.3969811}},{name:"故宫博物院",type:"location",location:{lat:39.9165884,lng:116.3972386}},{name:"中国国家图书馆",type:"location",location:{lat:39.945871,lng:116.322362}},{name:"中国国家体育场",type:"location",location:{lat:39.9929472,lng:116.3943225}},{name:"798艺术区",type:"location",location:{lat:39.9829545,lng:116.4929476}},{name:"簋街",type:"location",location:{lat:39.9410605,lng:116.4246827}},{name:"南锣鼓巷",type:"location",location:{lat:39.9370864,lng:116.4029372}},{name:"三里屯",type:"location",location:{lat:39.9324732,lng:116.4545548}},{name:"世贸天阶",type:"location",location:{lat:39.9167636,lng:116.4515275}},{name:"西单",type:"location",location:{lat:39.9095643,lng:116.3739301}},{name:"北京欢乐谷",type:"location",location:{lat:39.866418,lng:116.488627}},{name:"圆明园",type:"location",location:{lat:40.0081023,lng:116.2960261}},{name:"颐和园",type:"location",location:{lat:39.9999864,lng:116.2732719}},{name:"八达岭长城",type:"location",location:{lat:40.3597637,lng:116.0178317}}];!function(t,i){"use strict";var n=null,o=function(t){Object.assign(this,t||{}),this.active=ko.observable(!1),this.onActive=function(){n&&n.offActive(),this.active(!0),this.marker&&this.marker.onActive(),n=this},this.offActive=function(){this.active(!1),this.marker&&this.marker.offActive(),n=null},this.onClick=function(){this.active()?this.offActive():this.onActive()}};String.prototype.trimAll=function(){return this.replace(/\s+/g,"")};var e=function(t){this.mapsatue=ko.observable("loading"),this.keyword=ko.observable("").extend({rateLimit:300}),this.locations=ko.observableArray([]),this.noMatch=ko.observable(!1),this.addLocModes=function(t){var n=t.map(function(t){var n=new o(t);return i.googleMap&&(n=i.googleMap.newMarker(n)),n});this.locations(this.locations().concat(n))},t&&this.addLocModes(t),this.getMatchLoc=ko.pureComputed(function(){n&&n.offActive();var t=this.keyword().toString().trimAll(),i=[];return this.locations().map(function(n){var o=""===t||n.name.trimAll().indexOf(t)>-1;n.marker&&n.marker.setVisible(o),o&&i.push(n)}),i.length?this.noMatch(!1):this.noMatch(!0),i},this).extend({rateLimit:{timeout:300,method:"notifyWhenChangesStop"}})};i.searchVM=new e,ko.applyBindings(i.searchVM)}($,window),function(t,i){"use strict";var n={dom:document.getElementById("map"),local:"北京",center:{lat:39.9087191,lng:116.3952003},iconBase:"https://mingyili.github.io/assets/img/map/",wikiApiUrl:"https://zh.wikipedia.org/w/api.php?format=json&action=query&generator=search&gsrnamespace=0&gsrlimit=10&prop=pageimages|extracts&pilimit=max&exintro&explaintext&exsentences=1&exlimit=max&origin=*&gsrsearch="},o=function(i){this.opt=t.extend({},n,i),this.init()};o.prototype={init:function(){var t=this.opt;this.map=new google.maps.Map(t.dom,{center:t.center,zoom:13})},getMarkerIcon:function(t){return this.markerIcons=this.markerIcons||{},this.markerIcons[t]=this.markerIcons[t]||new google.maps.MarkerImage(this.opt.iconBase+t+".png"),this.markerIcons[t]},addMarkers:function(t){return t&&t.length?t.map(this.newMarker.bind(this)):this},newMarker:function(t){var i=this.getMarkerIcon(t.type),n=this.getMarkerIcon(t.type+"_hover"),o=this,e=new google.maps.Marker({position:t.location,title:t.name,icon:i,map:this.map,animation:google.maps.Animation.DROP});return e.addListener("mouseover",e.setIcon.bind(e,n)),e.addListener("mouseout",e.setIcon.bind(e,i)),e.onActive=function(){this.setAnimation(google.maps.Animation.BOUNCE),o.showInfoWinodw(t)},e.offActive=function(){this.setAnimation(null),t.infowindow&&t.infowindow.close()},e.addListener("click",t.onActive.bind(t)),t.marker=e,t},initInfowindow:function(t,i){i=i||{isDef:!0,text:t.name},t.infowindow=new google.maps.InfoWindow({content:['<div class="info-cont">',i.img?'<img src="'+i.img+'" class="info-img"/>':"",'<div class="info-text">',i.isDef?"<p>维基介绍：</p>":"",i.text+'<a target="_blank" href="https://en.wikipedia.org/wiki/'+t.name+'">--更多</a>',"</div>","</div>"].join("")}),t.infowindow.addListener("closeclick",t.offActive.bind(t)),t.active()&&t.infowindow.open(this.map,t.marker)},showInfoWinodw:function(i){if(i.infowindow)return i.infowindow.open(this.map,i.marker);var n=this,o=new RegExp(this.opt.local,"i");if(i.infoLoading)return!1;i.infoLoading=!0,t.ajax({url:this.opt.wikiApiUrl+i.name,dataType:"json",success:function(e){if(i.infoLoading=!1,!e||!e.query)return n.initInfowindow(i);var a=[];if(t.each(e.query.pages,function(t,i){!/refer to:$/.test(i.extract)&&o.test(i.extract)&&a.push(i)}),!a.length)return n.initInfowindow(i);a.sort(function(t,i){return t.index-i.index}),n.initInfowindow(i,{text:a[0].extract,img:a[0].thumbnail?a[0].thumbnail.source.replace(/33px|50px/,"100px"):""})},error:function(t){i.infoLoading=!1,console.log("wiki 数据加载失败"),n.initInfowindow(i)}})}},i.mapError=function(){i.searchVM.mapsatue("error")},i.initMap=function(){i.googleMap=new o,i.searchVM.mapsatue("success"),i.searchVM.addLocModes(locationDatas)}}($,window);