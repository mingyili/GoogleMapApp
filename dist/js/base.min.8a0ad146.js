var locationDatas=[{name:"天安门",type:"location",location:{lat:39.909191,lng:116.3969811}},{name:"故宫博物院",type:"location",location:{lat:39.9165884,lng:116.3972386}},{name:"中国国家图书馆",type:"location",location:{lat:39.945871,lng:116.322362}},{name:"中国国家体育场",type:"location",location:{lat:39.9929472,lng:116.3943225}},{name:"798艺术区",type:"location",location:{lat:39.9829545,lng:116.4929476}},{name:"簋街",type:"location",location:{lat:39.9410605,lng:116.4246827}},{name:"南锣鼓巷",type:"location",location:{lat:39.9370864,lng:116.4029372}},{name:"三里屯",type:"location",location:{lat:39.9324732,lng:116.4545548}},{name:"世贸天阶",type:"location",location:{lat:39.9167636,lng:116.4515275}},{name:"西单",type:"location",location:{lat:39.9095643,lng:116.3739301}},{name:"北京欢乐谷",type:"location",location:{lat:39.866418,lng:116.488627}},{name:"圆明园",type:"location",location:{lat:40.0081023,lng:116.2960261}},{name:"颐和园",type:"location",location:{lat:39.9999864,lng:116.2732719}},{name:"八达岭长城",type:"location",location:{lat:40.3597637,lng:116.0178317}}];!function(t,n){"use strict";var i=null,o=function(t){Object.assign(this,t||{}),this.active=ko.observable(!1),this.onActive=function(){i&&i.offActive(),this.active(!0),this.marker&&this.marker.onActive(),i=this},this.offActive=function(){this.active(!1),this.marker&&this.marker.offActive(),i=null},this.onClick=function(){this.active()?this.offActive():this.onActive()}};String.prototype.trimAll=function(){return this.replace(/\s+/g,"")};var e=function(t){this.keyword=ko.observable("").extend({rateLimit:300}),this.locations=ko.observableArray([]),this.noMatch=ko.observable(!1),this.addLocModes=function(t){var i=t.map(function(t){var i=new o(t);return n.googleMap&&(i=n.googleMap.newMarker(i)),i});this.locations(this.locations().concat(i))},t&&this.addLocModes(t),this.getMatchLoc=ko.pureComputed(function(){i&&i.offActive();var t=this.keyword().toString().trimAll(),n=[];return this.locations().map(function(i){var o=""===t||i.name.trimAll().indexOf(t)>-1;i.marker&&i.marker.setVisible(o),o&&n.push(i)}),n.length?this.noMatch(!1):this.noMatch(!0),n},this).extend({rateLimit:{timeout:300,method:"notifyWhenChangesStop"}})};n.searchVM=new e(locationDatas),ko.applyBindings(n.searchVM),n.afterMapLoad=function(t){t.addMarkers(n.searchVM.locations())}}($,window),function(t,n){"use strict";var i={dom:document.getElementById("map"),local:"北京",center:{lat:39.9087191,lng:116.3952003},iconBase:"https://mingyili.github.io/assets/img/map/",wikiApiUrl:"https://zh.wikipedia.org/w/api.php?format=json&action=query&generator=search&gsrnamespace=0&gsrlimit=10&prop=pageimages|extracts&pilimit=max&exintro&explaintext&exsentences=1&exlimit=max&origin=*&gsrsearch="},o=function(n){this.opt=t.extend({},i,n),this.init()};o.prototype={init:function(){var t=this.opt;this.map=new google.maps.Map(t.dom,{center:t.center,zoom:13})},getMarkerIcon:function(t){return this.markerIcons=this.markerIcons||{},this.markerIcons[t]=this.markerIcons[t]||new google.maps.MarkerImage(this.opt.iconBase+t+".png"),this.markerIcons[t]},addMarkers:function(t){return t&&t.length?t.map(this.newMarker.bind(this)):this},newMarker:function(t){var n=this.getMarkerIcon(t.type),i=this.getMarkerIcon(t.type+"_hover"),o=this,e=new google.maps.Marker({position:t.location,title:t.name,icon:n,map:this.map,animation:google.maps.Animation.DROP});return e.addListener("mouseover",e.setIcon.bind(e,i)),e.addListener("mouseout",e.setIcon.bind(e,n)),e.onActive=function(){this.setAnimation(google.maps.Animation.BOUNCE),o.showInfoWinodw(t)},e.offActive=function(){this.setAnimation(null),t.infowindow&&t.infowindow.close()},e.addListener("click",t.onActive.bind(t)),t.marker=e,t},initInfowindow:function(t,n){n=n||{isDef:!0,text:t.name},t.infowindow=new google.maps.InfoWindow({content:['<div class="info-cont">',n.img?'<img src="'+n.img+'" class="info-img"/>':"",'<div class="info-text">',n.isDef?"<p>维基介绍：</p>":"",n.text+'<a target="_blank" href="https://en.wikipedia.org/wiki/'+t.name+'">--更多</a>',"</div>","</div>"].join("")}),t.infowindow.addListener("closeclick",t.offActive.bind(t)),t.active()&&t.infowindow.open(this.map,t.marker)},showInfoWinodw:function(n){if(n.infowindow)return n.infowindow.open(this.map,n.marker);var i=this,o=new RegExp(this.opt.local,"i");if(n.infoLoading)return!1;n.infoLoading=!0,t.ajax({url:this.opt.wikiApiUrl+n.name,dataType:"json",success:function(e){if(n.infoLoading=!1,!e||!e.query)return i.initInfowindow(n);var a=[];if(t.each(e.query.pages,function(t,n){!/refer to:$/.test(n.extract)&&o.test(n.extract)&&a.push(n)}),!a.length)return i.initInfowindow(n);a.sort(function(t,n){return t.index-n.index}),i.initInfowindow(n,{text:a[0].extract,img:a[0].thumbnail?a[0].thumbnail.source.replace(/33px|50px/,"100px"):""})},error:function(t){n.infoLoading=!1,console.log("wiki 数据加载失败"),i.initInfowindow(n)}})}},n.mapError=function(){console.log("Google Map 加载失败")},n.initMap=function(){n.afterMapLoad(n.googleMap=new o)}}($,window);